name: Sync Notebook Examples to Docs

on:
  push:
    branches:
      - main
    paths:
      - '**/*.ipynb'
  pull_request:
    paths:
      - '**/*.ipynb'
  workflow_dispatch:
    inputs:
      force_all:
        description: 'Force conversion of all notebooks'
        required: false
        default: 'false'
        type: boolean
      skip_execution:
        description: 'Skip notebook execution (use raw notebooks without outputs)'
        required: false
        default: 'false'
        type: boolean

env:
  NOTEBOOKS_BUCKET: ${{ vars.NOTEBOOKS_BUCKET }}
  AWS_REGION: us-west-2

# Default permissions for all jobs (least privilege)
# Individual jobs override as needed
permissions:
  contents: read

jobs:
  # ============================================================================
  # Job 1: Execute notebooks in Wherobots Cloud
  # ============================================================================
  execute-notebooks:
    name: Execute Notebooks in Wherobots Cloud
    runs-on: ubuntu-latest
    # Skip on PRs (too expensive) or if skip_execution is true
    if: |
      github.event_name != 'pull_request' &&
      github.event.inputs.skip_execution != 'true'

    outputs:
      status: ${{ steps.poll.outputs.status }}
      manifest_url: ${{ steps.poll.outputs.manifest_url }}
      output_prefix: ${{ steps.prefix.outputs.output_prefix }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create unique run prefix
        id: prefix
        run: |
          RUN_ID="${{ github.run_id }}-${{ github.run_attempt }}"
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "input_prefix=notebook-runs/$RUN_ID/input" >> $GITHUB_OUTPUT
          echo "output_prefix=notebook-runs/$RUN_ID/output" >> $GITHUB_OUTPUT

      - name: Upload notebooks to S3
        run: |
          echo "Uploading notebooks to S3..."

          # Upload all notebooks (excluding Raster_Inference)
          for nb in $(find . -name "*.ipynb" ! -name "Raster_Inference*" -type f); do
            # Get relative path (remove leading ./)
            rel_path="${nb#./}"
            echo "Uploading: $rel_path"
            aws s3 cp "$nb" "s3://$NOTEBOOKS_BUCKET/${{ steps.prefix.outputs.input_prefix }}/$rel_path"
          done

          # Upload executor script
          echo ""
          echo "Uploading executor script..."
          aws s3 cp .github/workflows/scripts/execute_notebooks.py \
            "s3://$NOTEBOOKS_BUCKET/scripts/execute_notebooks.py"

          echo ""
          echo "Upload complete!"

      - name: Trigger Wherobots Runs API
        id: trigger
        run: |
          echo "Triggering Wherobots Runs API..."

          RESPONSE=$(curl -s -X POST \
            "https://api.cloud.wherobots.com/runs?region=aws-us-west-2" \
            -H "X-API-Key: ${{ secrets.WHEROBOTS_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "runtime": "medium",
              "name": "notebook-exec-${{ steps.prefix.outputs.run_id }}",
              "runPython": {
                "uri": "s3://'"$NOTEBOOKS_BUCKET"'/scripts/execute_notebooks.py",
                "args": [
                  "--s3-input-prefix", "s3://'"$NOTEBOOKS_BUCKET"'/${{ steps.prefix.outputs.input_prefix }}/",
                  "--s3-output-prefix", "s3://'"$NOTEBOOKS_BUCKET"'/${{ steps.prefix.outputs.output_prefix }}/",
                  "--timeout", "900"
                ]
              },
              "timeoutSeconds": 7200,
              "environment": {
                "dependencies": [
                  {"sourceType": "PYPI", "libraryName": "papermill", "libraryVersion": "2.6.0"}
                ]
              }
            }')

          echo "Response: $RESPONSE"
          RUN_ID=$(echo "$RESPONSE" | jq -r '.id')

          if [ "$RUN_ID" == "null" ] || [ -z "$RUN_ID" ]; then
            echo "ERROR: Failed to create Wherobots run"
            echo "$RESPONSE" | jq .
            exit 1
          fi

          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo ""
          echo "Created Wherobots run: $RUN_ID"
          echo "Monitor at: https://cloud.wherobots.com/job-runs"

      - name: Poll for completion
        id: poll
        run: |
          RUN_ID="${{ steps.trigger.outputs.run_id }}"
          MAX_WAIT=7200  # 2 hours max
          WAIT_TIME=0
          POLL_INTERVAL=30

          echo "Polling Wherobots run $RUN_ID for completion..."
          echo ""

          while [ $WAIT_TIME -lt $MAX_WAIT ]; do
            RESPONSE=$(curl -s "https://api.cloud.wherobots.com/runs/$RUN_ID" \
              -H "X-API-Key: ${{ secrets.WHEROBOTS_API_KEY }}")

            STATUS=$(echo "$RESPONSE" | jq -r '.status')
            echo "[$(date '+%H:%M:%S')] Status: $STATUS (waited ${WAIT_TIME}s)"

            case "$STATUS" in
              "COMPLETED")
                echo ""
                echo "Wherobots run completed successfully!"
                echo "status=COMPLETED" >> $GITHUB_OUTPUT
                echo "manifest_url=s3://$NOTEBOOKS_BUCKET/${{ steps.prefix.outputs.output_prefix }}/manifest.json" >> $GITHUB_OUTPUT
                exit 0
                ;;
              "FAILED")
                echo ""
                echo "ERROR: Wherobots run failed"
                echo "status=FAILED" >> $GITHUB_OUTPUT

                # Get logs
                echo ""
                echo "Run logs:"
                curl -s "https://api.cloud.wherobots.com/runs/$RUN_ID/logs?size=100" \
                  -H "X-API-Key: ${{ secrets.WHEROBOTS_API_KEY }}" | jq -r '.items[].raw' | tail -50

                exit 1
                ;;
              "CANCELLED")
                echo ""
                echo "ERROR: Wherobots run was cancelled"
                echo "status=CANCELLED" >> $GITHUB_OUTPUT
                exit 1
                ;;
              *)
                # Still running (PENDING, RUNNING)
                sleep $POLL_INTERVAL
                WAIT_TIME=$((WAIT_TIME + POLL_INTERVAL))
                ;;
            esac
          done

          echo ""
          echo "ERROR: Timeout waiting for run completion after ${MAX_WAIT}s"
          exit 1

      - name: Download executed notebooks
        run: |
          echo "Downloading executed notebooks from S3..."
          mkdir -p executed_notebooks

          aws s3 sync "s3://$NOTEBOOKS_BUCKET/${{ steps.prefix.outputs.output_prefix }}/" executed_notebooks/ \
            --exclude "manifest.json"

          echo ""
          echo "Downloaded notebooks:"
          find executed_notebooks -name "*.ipynb" -type f | sort

      - name: Download and display execution manifest
        run: |
          aws s3 cp "s3://$NOTEBOOKS_BUCKET/${{ steps.prefix.outputs.output_prefix }}/manifest.json" \
            executed_notebooks/manifest.json

          echo ""
          echo "Execution summary:"
          cat executed_notebooks/manifest.json | jq '{
            total: .total,
            success: .success,
            cell_error: .cell_error,
            failed: .failed,
            duration: (.end_time + " - " + .start_time)
          }'

      - name: Upload executed notebooks artifact
        uses: actions/upload-artifact@v4
        with:
          name: executed-notebooks
          path: executed_notebooks/
          retention-days: 7

  # ============================================================================
  # Job 2: Convert notebooks to MDX
  # ============================================================================
  convert-notebooks:
    name: Convert Notebooks to MDX
    runs-on: ubuntu-latest
    needs: [execute-notebooks]
    # Run if execute-notebooks succeeded OR was skipped (PRs, skip_execution=true)
    if: |
      always() &&
      (needs.execute-notebooks.result == 'success' || needs.execute-notebooks.result == 'skipped')
    permissions:
      contents: read
      pull-requests: write

    outputs:
      has_changes: ${{ steps.check-changes.outputs.has_changes }}
      file_count: ${{ steps.list-files.outputs.file_count }}

    steps:
      - name: Checkout wherobots-examples
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download executed notebooks (if available)
        if: needs.execute-notebooks.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: executed-notebooks
          path: executed_notebooks

      - name: Determine notebook source
        id: source
        run: |
          if [ -d "executed_notebooks" ] && [ "$(find executed_notebooks -name '*.ipynb' | head -1)" ]; then
            echo "Using executed notebooks (with outputs)"
            echo "source_dir=executed_notebooks" >> $GITHUB_OUTPUT
            echo "has_outputs=true" >> $GITHUB_OUTPUT
          else
            echo "Using raw notebooks (without outputs)"
            echo "source_dir=." >> $GITHUB_OUTPUT
            echo "has_outputs=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine notebooks to convert
        id: get-notebooks
        run: |
          SOURCE_DIR="${{ steps.source.outputs.source_dir }}"

          echo "Scanning for notebooks in: $SOURCE_DIR"
          NOTEBOOKS=$(find "$SOURCE_DIR" -type f -name "*.ipynb" ! -name "Raster_Inference*" | sort | tr '\n' ' ')

          echo "Notebooks to convert: $NOTEBOOKS"
          echo "notebooks=$NOTEBOOKS" >> $GITHUB_OUTPUT

          # Count notebooks
          COUNT=$(echo "$NOTEBOOKS" | wc -w)
          echo "count=$COUNT" >> $GITHUB_OUTPUT

      - name: Create output directory
        run: mkdir -p ${{ runner.temp }}/mdx_output

      - name: Convert notebooks to MDX
        run: |
          SOURCE_DIR="${{ steps.source.outputs.source_dir }}"

          for notebook in ${{ steps.get-notebooks.outputs.notebooks }}; do
            if [ -f "$notebook" ]; then
              echo "Converting: $notebook"

              # Determine output subdirectory and category
              # Strip the source dir prefix to get relative path
              rel_path="${notebook#$SOURCE_DIR/}"
              dir_name=$(dirname "$rel_path")
              category=$(echo "$dir_name" | cut -d'/' -f1)
              output_subdir="${{ runner.temp }}/mdx_output/${dir_name}"
              mkdir -p "$output_subdir"

              python .github/workflows/scripts/convert_notebook_to_mdx.py \
                "$notebook" "$output_subdir" \
                --category "$category" \
                --verbose
            fi
          done

      - name: List converted files
        id: list-files
        run: |
          echo "Converted MDX files:"
          find ${{ runner.temp }}/mdx_output -name "*.mdx" -type f | tee /tmp/converted_files.txt
          echo "file_count=$(wc -l < /tmp/converted_files.txt | tr -d ' ')" >> $GITHUB_OUTPUT

      - name: Check for changes
        id: check-changes
        run: |
          if [ -s /tmp/converted_files.txt ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload converted MDX files
        uses: actions/upload-artifact@v4
        with:
          name: mdx-files
          path: ${{ runner.temp }}/mdx_output
          retention-days: 7

      # Comment on PR with conversion summary
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let files = [];
            try {
              files = fs.readFileSync('/tmp/converted_files.txt', 'utf8').trim().split('\n').filter(f => f);
            } catch (e) {
              files = [];
            }

            const hasOutputs = '${{ steps.source.outputs.has_outputs }}' === 'true';
            const outputNote = hasOutputs
              ? '**With cell outputs** (notebooks were executed in Wherobots Cloud)'
              : '**Without cell outputs** (notebook execution is skipped for PRs)';

            const body = `## Notebook to MDX Conversion Preview

            This PR modifies **${files.length}** notebook(s) that will be converted to MDX and synced to the docs repository.

            ${outputNote}

            ### Files to be Updated
            ${files.map(f => {
              const rel = f.split('/mdx_output/')[1] || f;
              return `- \`examples/${rel}\``;
            }).join('\n')}

            ### What happens next?
            When this PR is merged to \`main\`:
            1. Notebooks will be executed in Wherobots Cloud (to capture outputs)
            2. All notebooks will be converted to MDX format
            3. A PR will be automatically created in \`wherobots/docs\`
            4. The Examples tab navigation will be auto-generated
            5. Merge the docs PR to publish the changes

            ### Local Preview
            \`\`\`bash
            # Preview all notebooks locally (without outputs)
            .github/workflows/scripts/preview_notebooks.sh

            # Preview with outputs (after downloading from S3)
            .github/workflows/scripts/preview_notebooks.sh --source ./executed_notebooks
            \`\`\`
            `;

            // Check for existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Notebook to MDX Conversion')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # ============================================================================
  # Job 3: Create PR in docs repository
  # ============================================================================
  create-docs-pr:
    name: Create Docs PR
    needs: [execute-notebooks, convert-notebooks]
    if: |
      always() &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      needs.convert-notebooks.outputs.has_changes == 'true' &&
      needs.convert-notebooks.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout wherobots-examples (for scripts)
        uses: actions/checkout@v4
        with:
          path: examples-repo

      - name: Download converted MDX files
        uses: actions/download-artifact@v4
        with:
          name: mdx-files
          path: mdx_output

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Checkout docs repository
        uses: actions/checkout@v4
        with:
          repository: wherobots/docs
          token: ${{ secrets.DOCS_REPO_TOKEN }}
          path: docs-repo

      - name: Sync MDX files to docs repository
        run: |
          TARGET_DIR="docs-repo/examples"

          # Remove existing examples to handle deletions
          rm -rf "$TARGET_DIR"
          mkdir -p "$TARGET_DIR"

          # Copy all converted MDX files
          if [ -d "mdx_output" ]; then
            cp -r mdx_output/* "$TARGET_DIR/"
            echo "Copied MDX files to $TARGET_DIR"
          fi

          # List synced files
          echo ""
          echo "Files synced to docs repository:"
          find "$TARGET_DIR" -name "*.mdx" -type f | sort

      - name: Update navigation in docs.json
        run: |
          python examples-repo/.github/workflows/scripts/generate_navigation.py \
            docs-repo/examples \
            docs-repo/docs.json

          echo ""
          echo "Updated docs.json navigation"

      - name: Create or update PR
        working-directory: docs-repo
        env:
          GH_TOKEN: ${{ secrets.DOCS_REPO_TOKEN }}
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are any changes
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Create branch name based on date
          BRANCH_NAME="sync-examples-$(date +%Y%m%d-%H%M%S)"
          SOURCE_SHA="${{ github.sha }}"
          SHORT_SHA="${SOURCE_SHA:0:7}"

          # Create and checkout branch
          git checkout -b "$BRANCH_NAME"

          # Stage all changes
          git add examples/ docs.json

          # Create commit
          git commit -m "docs: sync notebook examples from wherobots-examples

          Automated sync of Jupyter notebook examples converted to MDX format.
          Notebooks were executed in Wherobots Cloud to capture cell outputs.

          Source: wherobots/wherobots-examples@${SHORT_SHA}
          Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Changes include:
          - Updated MDX files in examples/ (with rendered outputs)
          - Auto-generated navigation for Examples tab"

          # Push branch
          git push origin "$BRANCH_NAME"

          # Create PR
          PR_BODY=$(cat <<'EOF'
          ## Sync Notebook Examples

          This PR syncs notebook examples from `wherobots/wherobots-examples` to the documentation.

          ### Changes
          - Updated MDX files in `examples/` directory
          - **Cell outputs are included** (notebooks were executed in Wherobots Cloud)
          - Auto-generated navigation for the **Examples** tab in `docs.json`

          ### Source
          - Repository: `wherobots/wherobots-examples`
          - Commit: ${{ github.sha }}
          - Workflow: [View run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ### Review Checklist
          - [ ] Preview the changes using `mint dev`
          - [ ] Verify the Examples tab navigation looks correct
          - [ ] Check that MDX files render properly with outputs

          ---
          *This PR was automatically generated. Merge to publish the changes.*
          EOF
          )

          gh pr create \
            --title "docs: sync notebook examples (${SHORT_SHA})" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH_NAME"

          echo ""
          echo "Pull request created successfully!"
