name: Upload Converted Notebooks to Git Tag
on:
  push:
    branches:
      - main
    tags:
      - "v**"
  workflow_dispatch:

jobs:
  convert-and-upload:
    name: Convert Notebooks to Python Scripts
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install nbconvert

      - name: Convert Jupyter Notebooks to python scripts
        id: convert-notebooks
        run: |
          echo "checking current folder $(pwd)"
          echo "checking current folder $(ls -al)"
          mkdir $RUNNER_TEMP/converted_notebooks
          echo "using $RUNNER_TEMP/converted_notebooks as output dir"
          for notebook in $(find . -type f -name "*.ipynb"); do
            echo "Converting $notebook to python script"
            jupyter nbconvert --config .github/workflows/config/nbconvert_config.py --to python --template .github/workflows/config/python_nomagic "$notebook" --output-dir=$RUNNER_TEMP/converted_notebooks
          done
          echo "Contents of $RUNNER_TEMP/converted_notebooks:"
          ls $RUNNER_TEMP/converted_notebooks
          tar -czf $RUNNER_TEMP/converted_notebooks.tar.gz -C $RUNNER_TEMP converted_notebooks
          echo "output_path=$RUNNER_TEMP/converted_notebooks.tar.gz" >> $GITHUB_OUTPUT

      # For versioned git tags (e.g., v1.0.0), we create a corresponding github release with the converted notebooks

      - name: Create Release for Tagged Notebooks
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2.5.0
        with:
          files: ${{ steps.convert-notebooks.outputs.output_path }}
          name: ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # For pushes to `main`, we use a mutable git tag / github release called `converted-notebooks` to always point to the latest converted notebooks

      - name: Update Converted Notebooks git tag
        if: github.ref_type == 'branch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f converted-notebooks
          git push origin converted-notebooks --force

      - name: Update Converted Notebooks Github Release
        if: github.ref_type == 'branch'
        uses: softprops/action-gh-release@v2.5.0
        with:
          files: ${{ steps.convert-notebooks.outputs.output_path }}
          name: converted-notebooks
          tag_name: converted-notebooks
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
